<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPO Data - DD Owl</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fafafa;
      color: #333;
      min-height: 100vh;
    }
    /* Navigation */
    .top-nav {
      background: #1a1a2e;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 32px;
    }
    .nav-brand {
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      text-decoration: none;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .nav-logo {
      height: 28px;
      width: auto;
    }
    .nav-links {
      display: flex;
      gap: 8px;
    }
    .nav-link {
      padding: 8px 16px;
      color: rgba(255,255,255,0.6);
      text-decoration: none;
      font-size: 13px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .nav-link:hover {
      color: #fff;
      background: rgba(255,255,255,0.1);
    }
    .nav-link.active {
      color: #fff;
      background: rgba(255,255,255,0.15);
    }
    .header {
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 24px;
    }
    .logo {
      font-weight: 700;
      font-size: 1.25rem;
      color: #1a1a2e;
    }
    .tabs {
      display: flex;
      gap: 4px;
    }
    .tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      color: #666;
    }
    .tab:hover { background: #f0f0f0; }
    .tab.active {
      background: #1a1a2e;
      color: #fff;
    }
    .container {
      padding: 24px;
      max-width: 1600px;
      margin: 0 auto;
    }
    .toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    .search-box {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      width: 250px;
    }
    .filter-select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      background: #fff;
    }
    .count-badge {
      background: #e8e8e8;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      color: #666;
      margin-left: auto;
    }
    .table-container {
      background: #fff;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th {
      background: #f8f8f8;
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: #555;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    th:hover { background: #f0f0f0; }
    th.sorted-asc::after { content: ' ▲'; color: #999; }
    th.sorted-desc::after { content: ' ▼'; color: #999; }
    td {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: top;
    }
    tr:hover { background: #fafafa; }
    .company-name {
      font-weight: 500;
      color: #1a1a2e;
    }
    .status-active {
      background: #dcfce7;
      color: #166534;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .status-listed {
      background: #dbeafe;
      color: #1e40af;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .status-withdrawn {
      background: #fee2e2;
      color: #991b1b;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .bank-tag {
      display: inline-block;
      background: #f3f4f6;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      margin: 2px 4px 2px 0;
    }
    .bank-tag.lead {
      background: #fef3c7;
      color: #92400e;
    }
    .bank-link {
      color: #2563eb;
      text-decoration: none;
      cursor: pointer;
    }
    .bank-link:hover { text-decoration: underline; }
    .pdf-link {
      color: #2563eb;
      text-decoration: none;
      font-size: 0.85rem;
      padding: 4px 8px;
      background: #eff6ff;
      border-radius: 4px;
    }
    .pdf-link:hover { background: #dbeafe; }
    .deal-count {
      font-weight: 600;
      color: #1a1a2e;
    }
    .section { display: none; }
    .section.active { display: block; }
    .pairings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }
    .pairing-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
    }
    .pairing-banks {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .pairing-arrow { color: #999; }
    .pairing-count {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1a1a2e;
    }
    .pairing-label {
      color: #666;
      font-size: 0.85rem;
    }
    .export-btn {
      background: #1a1a2e;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .export-btn:hover { background: #2a2a3e; }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <a href="/" class="nav-brand">DD OWL</a>
    <div class="nav-links">
      <a href="/" class="nav-link">Screening</a>
      <a href="/ipo" class="nav-link active">IPO Tracker</a>
    </div>
  </nav>
  <div class="header">
    <div class="logo">IPO Tracker</div>
    <div class="tabs">
      <button class="tab active" data-section="deals">Deals</button>
      <button class="tab" data-section="banks">Banks</button>
      <button class="tab" data-section="pairings">Bank Pairings</button>
    </div>
  </div>

  <div class="container">
    <!-- DEALS SECTION -->
    <div class="section active" id="deals-section">
      <div class="toolbar">
        <input type="text" class="search-box" id="deals-search" placeholder="Search companies...">
        <select class="filter-select" id="status-filter">
          <option value="">All Status</option>
          <option value="active">Active</option>
          <option value="listed">Listed</option>
          <option value="withdrawn">Withdrawn</option>
        </select>
        <select class="filter-select" id="board-filter">
          <option value="">All Boards</option>
          <option value="mainBoard">Main Board</option>
          <option value="gem">GEM</option>
        </select>
        <select class="filter-select" id="bank-filter">
          <option value="">All Banks</option>
        </select>
        <button class="export-btn" onclick="exportDeals()">Export CSV</button>
        <span class="count-badge" id="deals-count">0 deals</span>
      </div>
      <div class="table-container">
        <table id="deals-table">
          <thead>
            <tr>
              <th data-sort="company">Company</th>
              <th data-sort="board">Board</th>
              <th data-sort="status">Status</th>
              <th data-sort="filing_date">Filed</th>
              <th>Sponsors</th>
              <th>Coordinators</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody id="deals-body"></tbody>
        </table>
      </div>
    </div>

    <!-- BANKS SECTION -->
    <div class="section" id="banks-section">
      <div class="toolbar">
        <input type="text" class="search-box" id="banks-search" placeholder="Search banks...">
        <button class="export-btn" onclick="exportBanks()">Export CSV</button>
        <span class="count-badge" id="banks-count">0 banks</span>
      </div>
      <div class="table-container">
        <table id="banks-table">
          <thead>
            <tr>
              <th data-sort="name">Bank</th>
              <th data-sort="total_deals">Total Deals</th>
              <th data-sort="sponsor_deals">As Sponsor</th>
              <th data-sort="coordinator_deals">As Coordinator</th>
              <th>Top Partners</th>
            </tr>
          </thead>
          <tbody id="banks-body"></tbody>
        </table>
      </div>
    </div>

    <!-- PAIRINGS SECTION -->
    <div class="section" id="pairings-section">
      <div class="toolbar">
        <span class="count-badge" id="pairings-count">0 pairings</span>
      </div>
      <div class="pairings-grid" id="pairings-grid"></div>
    </div>
  </div>

  <script>
    let dealsData = [];
    let banksData = [];
    let pairingsData = [];
    let sortColumn = 'filing_date';
    let sortDir = 'desc';  // Default: newest first

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.section + '-section').classList.add('active');
      });
    });

    // Load data
    async function loadData() {
      // Load deals with banks
      const dealsRes = await fetch('/api/ipo/deals?limit=500');
      const dealsJson = await dealsRes.json();
      dealsData = dealsJson.deals || [];
      renderDeals();
      populateBankFilter();

      // Load banks
      const banksRes = await fetch('/api/ipo/banks');
      const banksJson = await banksRes.json();
      banksData = banksJson.banks || [];
      renderBanks();

      // Calculate pairings
      calculatePairings();
    }

    function shortBankName(name) {
      return name
        .replace(' (Hong Kong) Limited', '')
        .replace(' (Asia Pacific) Limited', '')
        .replace(' Limited', '')
        .replace(' Company', '')
        .replace(' Co.', '')
        .replace(' Securities', ' Sec')
        .replace(' Capital', ' Cap')
        .replace(' International', ' Intl')
        .replace('Corporation', 'Corp');
    }

    function renderDeals() {
      const search = document.getElementById('deals-search').value.toLowerCase();
      const statusFilter = document.getElementById('status-filter').value;
      const boardFilter = document.getElementById('board-filter').value;
      const bankFilter = document.getElementById('bank-filter').value;

      let filtered = dealsData.filter(d => {
        if (search && !d.company_name?.toLowerCase().includes(search)) return false;
        if (statusFilter && d.status !== statusFilter) return false;
        if (boardFilter && d.board !== boardFilter) return false;
        if (bankFilter && !d.banks?.some(b => b.bank_id == bankFilter)) return false;
        return true;
      });

      // Sort
      if (sortColumn) {
        filtered.sort((a, b) => {
          let aVal = a[sortColumn] || '';
          let bVal = b[sortColumn] || '';
          if (sortColumn === 'company') {
            aVal = a.company_name || '';
            bVal = b.company_name || '';
          }
          if (sortColumn === 'filing_date') {
            // Sort dates properly
            aVal = a.filing_date ? new Date(a.filing_date).getTime() : 0;
            bVal = b.filing_date ? new Date(b.filing_date).getTime() : 0;
          } else if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = (bVal || '').toLowerCase();
          }
          if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
          if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
          return 0;
        });
      }

      document.getElementById('deals-count').textContent = filtered.length + ' deals';

      const tbody = document.getElementById('deals-body');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No deals found</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(d => {
        // roles is now an array like ['sponsor', 'coordinator']
        const sponsors = (d.banks || []).filter(b => (b.roles || []).includes('sponsor'));
        // Coordinators: only show if NOT already a sponsor (highest rank takes priority)
        const coords = (d.banks || []).filter(b =>
          (b.roles || []).includes('coordinator') && !(b.roles || []).includes('sponsor')
        );
        const pdfLink = (d.pdf_links && d.pdf_links.length > 0) ? d.pdf_links[0] : null;

        // Format board: "Main Board" -> "Main", "GEM" stays as is
        const boardDisplay = (d.board || '-').replace(' Board', '');
        // Format status: capitalize first letter
        const statusDisplay = d.status ? d.status.charAt(0).toUpperCase() + d.status.slice(1) : '-';
        // Company name with Chinese name if available
        const companyDisplay = d.company_name_cn
          ? `${d.company_name} (${d.company_name_cn})`
          : (d.company_name || '-');

        return `
          <tr>
            <td class="company-name">${companyDisplay}</td>
            <td>${boardDisplay}</td>
            <td><span class="status-${d.status || 'active'}">${statusDisplay}</span></td>
            <td>${d.filing_date ? new Date(d.filing_date).toLocaleDateString() : '-'}</td>
            <td>${sponsors.map(b => `<span class="bank-tag lead" title="${b.raw_role || 'Sponsor'}">${b.bank_name}</span>`).join('') || '-'}</td>
            <td>${coords.map(b => `<span class="bank-tag" title="${b.raw_role || 'Coordinator'}">${b.bank_name}</span>`).join('') || '-'}</td>
            <td>${pdfLink ? `<a href="${pdfLink}" target="_blank" class="pdf-link">PDF</a>` : '-'}</td>
          </tr>
        `;
      }).join('');
    }

    function populateBankFilter() {
      const bankSet = new Map();
      dealsData.forEach(d => {
        (d.banks || []).forEach(b => {
          if (!bankSet.has(b.bank_id)) {
            bankSet.set(b.bank_id, b.bank_name);
          }
        });
      });

      const select = document.getElementById('bank-filter');
      select.innerHTML = '<option value="">All Banks</option>' +
        Array.from(bankSet.entries())
          .sort((a, b) => a[1].localeCompare(b[1]))
          .map(([id, name]) => `<option value="${id}">${shortBankName(name)}</option>`)
          .join('');
    }

    function renderBanks() {
      const search = document.getElementById('banks-search').value.toLowerCase();

      let filtered = banksData.filter(b => {
        if (search && !b.bank_name?.toLowerCase().includes(search)) return false;
        return true;
      });

      document.getElementById('banks-count').textContent = filtered.length + ' banks';

      const tbody = document.getElementById('banks-body');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No banks found</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(b => `
        <tr>
          <td class="company-name">${b.bank_name || '-'}</td>
          <td class="deal-count">${b.total_deals || 0}</td>
          <td>${b.sponsor_deals || 0}</td>
          <td>${b.coordinator_deals || 0}</td>
          <td>-</td>
        </tr>
      `).join('');
    }

    function calculatePairings() {
      const pairMap = new Map();

      dealsData.forEach(d => {
        const banks = (d.banks || []).map(b => b.bank_name).filter(Boolean);
        for (let i = 0; i < banks.length; i++) {
          for (let j = i + 1; j < banks.length; j++) {
            const key = [banks[i], banks[j]].sort().join('|||');
            pairMap.set(key, (pairMap.get(key) || 0) + 1);
          }
        }
      });

      pairingsData = Array.from(pairMap.entries())
        .map(([key, count]) => {
          const [a, b] = key.split('|||');
          return { bankA: a, bankB: b, count };
        })
        .sort((a, b) => b.count - a.count);

      renderPairings();
    }

    function renderPairings() {
      document.getElementById('pairings-count').textContent = pairingsData.length + ' pairings';

      const grid = document.getElementById('pairings-grid');
      if (pairingsData.length === 0) {
        grid.innerHTML = '<div class="empty-state">No pairings found</div>';
        return;
      }

      grid.innerHTML = pairingsData.slice(0, 20).map(p => `
        <div class="pairing-card">
          <div class="pairing-banks">
            <span class="bank-tag">${shortBankName(p.bankA)}</span>
            <span class="pairing-arrow">+</span>
            <span class="bank-tag">${shortBankName(p.bankB)}</span>
          </div>
          <div class="pairing-count">${p.count}</div>
          <div class="pairing-label">deals together</div>
        </div>
      `).join('');
    }

    // Sorting
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.sort;
        if (sortColumn === col) {
          sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = col;
          sortDir = 'asc';
        }
        document.querySelectorAll('th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
        th.classList.add(sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
        renderDeals();
      });
    });

    // Search/filter handlers
    document.getElementById('deals-search').addEventListener('input', renderDeals);
    document.getElementById('status-filter').addEventListener('change', renderDeals);
    document.getElementById('board-filter').addEventListener('change', renderDeals);
    document.getElementById('bank-filter').addEventListener('change', renderDeals);
    document.getElementById('banks-search').addEventListener('input', renderBanks);

    // Export
    function exportDeals() {
      const csv = 'Company,Board,Status,Filed,Sponsors,Coordinators\n' +
        dealsData.map(d => {
          const sponsors = (d.banks || []).filter(b => (b.roles || []).includes('sponsor')).map(b => b.bank_name).join('; ');
          const coords = (d.banks || []).filter(b => (b.roles || []).includes('coordinator')).map(b => b.bank_name).join('; ');
          return `"${d.company_name || ''}","${d.board || ''}","${d.status || ''}","${d.filing_date || ''}","${sponsors}","${coords}"`;
        }).join('\n');
      download('deals.csv', csv);
    }

    function exportBanks() {
      const csv = 'Bank,Total Deals,Sponsor,Coordinator\n' +
        banksData.map(b => `"${b.bank_name}",${b.total_deals},${b.sponsor_deals},${b.coordinator_deals}`).join('\n');
      download('banks.csv', csv);
    }

    function download(filename, content) {
      const blob = new Blob([content], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
    }

    loadData();
  </script>
</body>
</html>
