<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DD Owl</title>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }
    /* Navigation */
    .top-nav {
      background: #111;
      border-bottom: 1px solid #222;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 32px;
    }
    .nav-links {
      display: flex;
      gap: 8px;
    }
    .nav-link {
      padding: 8px 16px;
      color: #888;
      text-decoration: none;
      font-size: 13px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .nav-link:hover {
      color: #fff;
      background: #1a1a1a;
    }
    .nav-link.active {
      color: #fff;
      background: #222;
    }
    /* Tab container - centered underline style */
    .tab-container {
      display: flex;
      justify-content: center;
      gap: 48px;
      padding: 24px 0;
      border-bottom: 1px solid #1a1a1a;
    }
    .tab {
      background: transparent;
      border: none;
      color: #666;
      font-size: 1rem;
      font-family: inherit;
      padding: 12px 4px;
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }
    .tab:hover {
      color: #999;
    }
    .tab.active {
      color: #fff;
    }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: #4a9eff;
      border-radius: 3px 3px 0 0;
    }
    .tab-count {
      color: #555;
      font-weight: 400;
      margin-left: 6px;
    }
    .tab.active .tab-count {
      color: #888;
    }
    .container {
      padding: 24px;
      max-width: 1800px;
      margin: 0 auto;
    }
    .toolbar {
      display: flex;
      gap: 24px;
      margin-bottom: 24px;
      align-items: center;
      padding: 0;
    }
    .search-wrapper {
      position: relative;
      width: 450px;
      min-width: 450px;
      flex-shrink: 0;
    }
    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      pointer-events: none;
    }
    .search-box {
      width: 100%;
      padding: 12px 16px 12px 44px;
      background: #141414;
      border: 1px solid transparent;
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: inherit;
      color: #fff;
      outline: none;
      transition: all 0.2s;
    }
    .search-box::placeholder {
      color: #555;
    }
    .search-box:hover {
      background: #1a1a1a;
    }
    .search-box:focus {
      background: #111;
      border-color: #333;
    }
    /* Spacer for toolbar */
    .toolbar-spacer {
      flex: 1;
    }
    /* Year Pills - REMOVED, using search instead */
    .year-pills {
      display: none;
    }
    .year-pill {
      display: none;
      padding: 8px 14px;
      background: transparent;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      font-family: inherit;
      color: #666;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .year-pill:hover {
      color: #999;
      background: #1a1a1a;
    }
    .year-pill.active {
      color: #fff;
      background: #1a1a1a;
    }
    .count-badge {
      font-size: 0.85rem;
      color: #555;
      margin-left: auto;
      white-space: nowrap;
    }
    .table-container {
      background: #111;
      border-radius: 8px;
      border: 1px solid #222;
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    th {
      background: #1a1a1a;
      padding: 12px 14px;
      text-align: left;
      font-weight: 600;
      color: #888;
      position: relative;
      user-select: none;
    }
    th.dragging {
      opacity: 0.5;
      background: #2a2a3a;
    }
    th.drag-over {
      border-left: 2px solid #4a9eff;
    }
    th .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 6px;
      cursor: col-resize;
      background: transparent;
    }
    th .resize-handle:hover,
    th .resize-handle.resizing {
      background: #4a9eff;
      border-bottom: 1px solid #222;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 1px;
    }
    th:hover { background: #222; color: #fff; }
    th.sorted-asc::after { content: ' ▲'; color: #4a9eff; }
    th.sorted-desc::after { content: ' ▼'; color: #4a9eff; }
    td {
      padding: 12px 14px;
      border-bottom: 1px solid #1a1a1a;
      vertical-align: middle;
      color: #ccc;
    }
    tr:hover { background: #1a1a1a; }
    .company-name {
      font-weight: 500;
      color: #fff;
      max-width: 490px;
      line-height: 1.3;
    }
    .company-cn {
      color: #888;
      font-weight: 400;
    }
    .ticker {
      color: #4a9eff;
      font-weight: 600;
    }
    .ticker a {
      color: #4a9eff;
      text-decoration: none;
    }
    .ticker a:hover {
      text-decoration: underline;
      color: #6bb3ff;
    }
    .status-active {
      background: #1a3a1a;
      color: #2ed573;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-listed {
      background: #1a2a3a;
      color: #4a9eff;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .bank-tag {
      display: inline-block;
      background: #1a1a1a;
      border: 1px solid #333;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      margin: 2px 4px 2px 0;
      color: #aaa;
    }
    .bank-tag.sponsor {
      background: #2a2a1a;
      border-color: #ffa502;
      color: #ffa502;
    }
    .role-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .role-sponsor {
      background: #2a1a1a;
      color: #ffa502;
      border: 1px solid #ffa502;
    }
    .role-other {
      background: #1a1a2a;
      color: #888;
      border: 1px solid #333;
    }
    .date-cell {
      color: #666;
      white-space: nowrap;
      font-size: 0.8rem;
    }
    .deal-type-cell {
      color: #aaa;
      font-size: 0.8rem;
      white-space: nowrap;
    }
    .banks-cell {
      line-height: 1.8;
    }
    .size-cell {
      color: #4a9eff;
      font-weight: 600;
      text-align: right;
    }
    .industry-cell {
      color: #e0e0e0;
      font-size: 0.8rem;
      max-width: 200px;
      line-height: 1.3;
    }
    .sub-industry {
      color: #666;
      font-size: 0.75rem;
    }
    .dual-listing-cell {
      text-align: center;
    }
    .ah-badge {
      background: linear-gradient(135deg, #ff6b6b 0%, #ffc107 100%);
      color: #000;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
    }
    .no-size-label {
      color: #666;
      font-size: 0.85em;
      font-weight: normal;
    }
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #555;
    }
    .empty-state h3 {
      font-size: 1.1rem;
      color: #888;
      margin-bottom: 8px;
    }
    .section { display: none; }
    .section.active { display: block; }

    /* Pipeline placeholder */
    .pipeline-placeholder {
      background: #111;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 60px 40px;
      text-align: center;
    }
    .pipeline-placeholder h2 {
      color: #fff;
      margin-bottom: 12px;
      font-size: 1.25rem;
    }
    .pipeline-placeholder p {
      color: #666;
      font-size: 0.9rem;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 20px;
    }
    .page-btn {
      padding: 8px 14px;
      background: #1a1a1a;
      border: 1px solid #333;
      color: #888;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.85rem;
    }
    .page-btn:hover {
      background: #222;
      color: #fff;
    }
    .page-btn.active {
      background: #4a9eff;
      color: #000;
      border-color: #4a9eff;
    }
    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .page-info {
      color: #666;
      font-size: 0.85rem;
      padding: 8px 14px;
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <div class="nav-links">
      <a href="/" class="nav-link">Screening</a>
      <a href="/ipo" class="nav-link active">IPO Tracker</a>
    </div>
  </nav>
  <div class="tab-container">
    <button class="tab active" data-section="active">
      Active <span class="tab-count" id="active-count">(0)</span>
    </button>
    <button class="tab" data-section="historical">
      Historical <span class="tab-count" id="historical-count">(0)</span>
    </button>
  </div>

  <div class="container">
    <!-- ACTIVE SECTION -->
    <div class="section active" id="active-section">
      <div class="toolbar">
        <div class="search-wrapper">
          <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="text" class="search-box" id="active-search" placeholder="Search companies, banks, year (e.g. 2024)...">
        </div>
        <div class="toolbar-spacer"></div>
        <span class="count-badge" id="active-count-badge">Loading...</span>
      </div>
      <div class="table-container">
        <table id="active-table">
          <thead><tr></tr></thead>
          <tbody id="active-table-body"></tbody>
        </table>
      </div>
      <div class="pagination" id="active-pagination"></div>
    </div>

    <!-- HISTORICAL SECTION -->
    <div class="section" id="historical-section">
      <div class="toolbar">
        <div class="search-wrapper">
          <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="text" class="search-box" id="search" placeholder="Search companies, tickers, banks, year (e.g. 2024)...">
        </div>
        <div class="toolbar-spacer"></div>
        <span class="count-badge" id="count-badge">Loading...</span>
      </div>
      <div class="table-container">
        <table id="data-table">
          <thead><tr></tr></thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <script>
    let rawData = [];
    let allData = [];
    let filteredData = [];
    let sortColumn = 'date';
    let sortDir = 'desc';
    let currentPage = 1;
    const pageSize = 50;
    let currentYearFilter = '';

    // Active deals state
    let activeData = [];
    let activeFilteredData = [];
    let activeSortColumn = 'ocDate';
    let activeSortDir = 'desc';
    let activeCurrentPage = 1;
    let activeYearFilter = '';

    // Active columns (no ticker, no size)
    const activeColumns = [
      { id: 'company', label: 'Company', width: 500, visible: true, sortable: true },
      { id: 'ocDate', label: 'OC Date', width: 100, visible: true, sortable: true },
      { id: 'sponsors', label: 'Sponsors', width: 250, visible: true, sortable: false },
      { id: 'others', label: 'Others', width: 300, visible: true, sortable: false },
    ];

    // Column configuration - order can be changed by user
    let columns = [
      { id: 'ticker', label: 'Ticker', width: 70, visible: true, sortable: true },
      { id: 'company', label: 'Company', width: 350, visible: true, sortable: true },
      { id: 'date', label: 'Date', width: 90, visible: true, sortable: true },
      { id: 'dealType', label: 'Deal Type', width: 130, visible: true, sortable: true },
      { id: 'sizeHKDm', label: 'Size (HKDm)', width: 100, visible: true, sortable: true },
      { id: 'industry', label: 'Industry', width: 200, visible: true, sortable: true },
      { id: 'isDualListing', label: 'Dual', width: 50, visible: true, sortable: true },
      { id: 'sponsors', label: 'Sponsors', width: 200, visible: true, sortable: false },
      { id: 'others', label: 'Others', width: 250, visible: true, sortable: false },
    ];

    // Dual listing exchange lookup
    // A-shares: HK+SH (Shanghai), HK+SZ (Shenzhen)
    // ADRs: HK+NYSE, HK+NASDAQ
    const DUAL_EXCHANGE = {
      // A+H shares (China mainland)
      '300': 'HK+SZ', '1304': 'HK+SH', '1347': 'HK+SH', '1354': 'HK+SH', '1375': 'HK+SH',
      '1501': 'HK+SH', '1530': 'HK+SH', '1679': 'HK+SH', '1786': 'HK+SH', '1858': 'HK+SH',
      '1877': 'HK+SH', '2016': 'HK+SH', '2359': 'HK+SH', '2611': 'HK+SH', '2648': 'HK+SH',
      '3288': 'HK+SH', '3347': 'HK+SZ', '3606': 'HK+SH', '3678': 'HK+SZ', '3750': 'HK+SZ',
      '3759': 'HK+SZ', '3908': 'HK+SH', '3958': 'HK+SH', '3969': 'HK+SH', '3996': 'HK+SH',
      '6066': 'HK+SH', '6099': 'HK+SH', '6127': 'HK+SH', '6160': 'HK+SH', '6178': 'HK+SH',
      '6655': 'HK+SH', '6680': 'HK+SZ', '6693': 'HK+SH', '6821': 'HK+SZ', '6826': 'HK+SH',
      '6886': 'HK+SH', '9989': 'HK+SZ',
      // US ADRs (secondary listings from US)
      '9988': 'HK+NYSE',   // Alibaba (BABA)
      '9618': 'HK+NASDAQ', // JD.com (JD)
      '9888': 'HK+NASDAQ', // Baidu (BIDU)
      '9999': 'HK+NASDAQ', // NetEase (NTES)
      '9626': 'HK+NASDAQ', // Bilibili (BILI)
      '9866': 'HK+NYSE',   // NIO (NIO)
      '9868': 'HK+NYSE',   // XPeng (XPEV)
      '2015': 'HK+NASDAQ', // Li Auto (LI)
      '9961': 'HK+NASDAQ', // Trip.com (TCOM)
      '9898': 'HK+NASDAQ', // Weibo (WB)
      '9896': 'HK+NYSE',   // MINISO (MNSO)
      '2076': 'HK+NASDAQ', // Kanzhun/BOSS Zhipin (BZ)
    };

    // Format company name with Chinese below English, and remove comma from Co., Ltd.
    function formatCompanyName(company, companyCn, asHtml = false) {
      // Remove comma from "Co., Ltd." → "Co. Ltd."
      let name = (company || '').replace(/Co\.,\s*Ltd\.?/gi, 'Co. Ltd.');
      if (companyCn && asHtml) {
        return `${escapeHtml(name)}<br><span class="company-cn">${escapeHtml(companyCn)}</span>`;
      }
      if (companyCn) {
        return `${name}\n${companyCn}`;  // For CSV export
      }
      return asHtml ? escapeHtml(name) : name;
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.section + '-section').classList.add('active');
      });
    });

    // Load enriched CSV data (already grouped by deal)
    async function loadData() {
      try {
        const response = await fetch('/baseline-enriched.csv');
        const text = await response.text();
        const lines = text.replace(/^\uFEFF/, '').replace(/\r/g, '').split('\n');
        const headers = parseCSVLine(lines[0]);

        allData = [];
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          const values = parseCSVLine(lines[i]);
          const row = {};
          headers.forEach((h, idx) => {
            row[h] = values[idx] || '';
          });

          // Parse enriched format
          allData.push({
            ticker: row.ticker,
            company: row.company,
            companyCn: row.company_cn || '',
            type: row.type,
            date: row.date,
            dealType: row.deal_type || '',
            shares: parseFloat(row.shares) || null,
            price: parseFloat(row.price_hkd) || null,
            sizeHKDm: isNaN(parseFloat(row.size_hkdm)) ? (row.size_hkdm || null) : parseFloat(row.size_hkdm),
            industry: row.industry || '',
            subIndustry: row.sub_industry || '',
            sector: row.sector || '',
            isDualListing: row.is_dual_listing === 'Y',
            sponsors: row.sponsors ? row.sponsors.split('; ').filter(Boolean) : [],
            others: row.others ? row.others.split('; ').filter(Boolean) : [],
            prospectusUrl: row.prospectus_url || ''
          });
        }

        populateYearFilter();
        updateTabCounts();
        applyFilters();
      } catch (err) {
        console.error('Failed to load data:', err);
        const visibleCols = columns.filter(c => c.visible);
        document.getElementById('table-body').innerHTML =
          `<tr><td colspan="${visibleCols.length}" class="empty-state">Failed to load data</td></tr>`;
      }
    }

    // Load active deals CSV
    async function loadActiveData() {
      try {
        const response = await fetch('/active-deals.csv');
        const text = await response.text();
        const lines = text.replace(/^\uFEFF/, '').replace(/\r/g, '').split('\n');
        const headers = parseCSVLine(lines[0]);

        activeData = [];
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          const values = parseCSVLine(lines[i]);
          const row = {};
          headers.forEach((h, idx) => {
            row[h] = values[idx] || '';
          });

          activeData.push({
            company: row.company,
            ocDate: row.oc_date,
            sponsors: row.sponsors ? row.sponsors.split('; ').filter(Boolean) : [],
            others: row.others ? row.others.split('; ').filter(Boolean) : [],
            documentUrl: row.document_url || ''
          });
        }

        populateActiveYearFilter();
        updateTabCounts();
        applyActiveFilters();
      } catch (err) {
        console.error('Failed to load active data:', err);
        document.getElementById('active-table-body').innerHTML =
          `<tr><td colspan="${activeColumns.length}" class="empty-state">Failed to load active deals</td></tr>`;
      }
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    }

    function updateTabCounts() {
      // Active count = total active deals
      const activeCount = activeData.length;
      document.getElementById('active-count').textContent = `(${activeCount})`;

      // Historical count = total items
      const historicalCount = allData.length;
      document.getElementById('historical-count').textContent = `(${historicalCount.toLocaleString()})`;
    }

    function populateYearFilter() {
      // Year filter removed - using search bar instead
    }

    function applyFilters() {
      const search = document.getElementById('search').value.toLowerCase();

      filteredData = allData.filter(row => {
        if (search) {
          // Include date/year in searchable fields
          const searchFields = [
            row.company,
            row.companyCn,
            row.ticker,
            row.date,
            row.dealType,
            row.sector,
            ...row.sponsors,
            ...row.others
          ].join(' ').toLowerCase();
          if (!searchFields.includes(search)) return false;
        }

        return true;
      });

      sortData();
      currentPage = 1;

      document.getElementById('count-badge').textContent =
        filteredData.length.toLocaleString() + ' deals';

      renderTableWithColumns();
      renderPagination();
    }

    // Render table headers and body using column config
    function renderTableWithColumns() {
      const visibleCols = columns.filter(c => c.visible);
      const thead = document.querySelector('#data-table thead');

      // Build header row with resize handles and drag support
      thead.innerHTML = `<tr>${visibleCols.map((col, idx) => {
        const sortClass = sortColumn === col.id ? (sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
        const sortAttr = col.sortable ? `data-sort="${col.id}"` : '';
        return `<th ${sortAttr} data-col-id="${col.id}" data-col-idx="${idx}" draggable="true" style="width: ${col.width}px;" class="${sortClass}">${col.label}<span class="resize-handle" data-col-idx="${idx}"></span></th>`;
      }).join('')}</tr>`;

      initSortHandlers();
      initColumnResize('#data-table', columns);
      initColumnDrag('#data-table', columns, () => { renderTableWithColumns(); renderTable(); });
      renderTable();
    }

    // Initialize sort click handlers on headers
    function initSortHandlers() {
      document.querySelectorAll('#data-table th[data-sort]').forEach(th => {
        th.addEventListener('click', (e) => {
          // Ignore if clicking resize handle
          if (e.target.classList.contains('resize-handle')) return;

          const col = th.dataset.sort;
          if (sortColumn === col) {
            sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            sortColumn = col;
            sortDir = 'asc';
          }
          document.querySelectorAll('#data-table th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
          th.classList.add(sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
          sortData();
          renderTable();
        });
      });
    }

    function sortData() {
      filteredData.sort((a, b) => {
        let aVal = a[sortColumn] || '';
        let bVal = b[sortColumn] || '';

        if (sortColumn === 'date') {
          const parseDate = (d) => {
            const parts = d.split('/');
            if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]).getTime();
            return 0;
          };
          aVal = parseDate(aVal);
          bVal = parseDate(bVal);
        } else if (sortColumn === 'ticker' || sortColumn === 'sizeHKDm') {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
        } else if (sortColumn === 'isDualListing') {
          // Use DUAL_EXCHANGE lookup for proper sorting
          aVal = DUAL_EXCHANGE[a.ticker] || '';
          bVal = DUAL_EXCHANGE[b.ticker] || '';
        } else {
          aVal = String(aVal).toLowerCase();
          bVal = String(bVal).toLowerCase();
        }

        if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function renderTable() {
      const visibleCols = columns.filter(c => c.visible);
      const start = (currentPage - 1) * pageSize;
      const pageData = filteredData.slice(start, start + pageSize);
      const tbody = document.getElementById('table-body');

      if (pageData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${visibleCols.length}" class="empty-state">No results found</td></tr>`;
        return;
      }

      tbody.innerHTML = pageData.map(row => `
        <tr>
          ${visibleCols.map(col => renderCell(row, col)).join('')}
        </tr>
      `).join('');
    }

    function renderCell(row, col) {
      switch (col.id) {
        case 'ticker':
          const pdfUrl = row.prospectusUrl || '';
          if (pdfUrl) {
            return `<td class="ticker"><a href="${pdfUrl}" target="_blank" title="Open prospectus PDF">${row.ticker}</a></td>`;
          }
          return `<td class="ticker">${row.ticker}</td>`;
        case 'company':
          const displayHtml = formatCompanyName(row.company, row.companyCn, true);
          const plainName = formatCompanyName(row.company, row.companyCn, false);
          return `<td class="company-name" title="${escapeHtml(plainName)}">${displayHtml}</td>`;
        case 'date':
          return `<td class="date-cell">${formatDate(row.date)}</td>`;
        case 'dealType':
          return `<td class="deal-type-cell">${escapeHtml(row.dealType || '-')}</td>`;
        case 'sizeHKDm':
          return `<td class="size-cell">${formatSize(row.sizeHKDm, row.type)}</td>`;
        case 'industry':
          const industryDisplay = row.industry || row.sector || '';
          const subIndustryDisplay = row.subIndustry || '';
          if (industryDisplay && subIndustryDisplay) {
            return `<td class="industry-cell" title="${escapeHtml(industryDisplay)} / ${escapeHtml(subIndustryDisplay)}">${escapeHtml(industryDisplay)}<br><span class="sub-industry">${escapeHtml(subIndustryDisplay)}</span></td>`;
          }
          return `<td class="industry-cell">${industryDisplay ? escapeHtml(industryDisplay) : '-'}</td>`;
        case 'isDualListing':
          const exchange = DUAL_EXCHANGE[row.ticker] || (row.isDualListing ? 'A+H' : '');
          return `<td class="dual-listing-cell">${exchange ? '<span class="ah-badge">' + exchange + '</span>' : ''}</td>`;
        case 'sponsors':
          return `<td class="banks-cell">${row.sponsors.map(b => `<span class="bank-tag sponsor">${escapeHtml(b)}</span>`).join(' ') || '-'}</td>`;
        case 'others':
          return `<td class="banks-cell">${row.others.map(b => `<span class="bank-tag">${escapeHtml(b)}</span>`).join(' ') || '-'}</td>`;
        default:
          return `<td>-</td>`;
      }
    }

    function formatSize(size, type) {
      // Handle string labels (e.g., "Listing by Introduction", "SPAC", etc.)
      if (typeof size === 'string') {
        const sizeLower = size.toLowerCase();
        if (sizeLower.includes('introduction')) return '<span class="no-size-label">Introduction</span>';
        if (sizeLower.includes('transfer')) return '<span class="no-size-label">Transfer</span>';
        if (sizeLower.includes('spac')) return '<span class="no-size-label">SPAC</span>';
        if (sizeLower.includes('n/a') || sizeLower.includes('unavailable')) return '<span class="no-size-label">Unavailable</span>';
        return '<span class="no-size-label">' + size + '</span>';
      }
      if (!size) {
        // Fallback: check type for unlabeled deals
        const typeLower = (type || '').toLowerCase();
        if (typeLower.includes('transfer')) return '<span class="no-size-label">Transfer</span>';
        if (typeLower.includes('introduction')) return '<span class="no-size-label">Introduction</span>';
        if (typeLower.includes('spac')) return '<span class="no-size-label">SPAC</span>';
        return '-';
      }
      if (size >= 1000) {
        return (size / 1000).toFixed(1) + 'B';
      }
      return size.toFixed(0) + 'M';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const parts = dateStr.split('/');
      if (parts.length !== 3) return dateStr;
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return `${months[parseInt(parts[1]) - 1]} ${parts[2]}`;
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredData.length / pageSize);
      const container = document.getElementById('pagination');

      if (totalPages <= 1) { container.innerHTML = ''; return; }

      container.innerHTML = `
        <button class="page-btn" onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>First</button>
        <button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Prev</button>
        <span class="page-info">Page ${currentPage} of ${totalPages}</span>
        <button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
        <button class="page-btn" onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last</button>
      `;
    }

    function goToPage(page) {
      currentPage = page;
      renderTable();
      renderPagination();
      window.scrollTo(0, 0);
    }

    // ========== ACTIVE DEALS FUNCTIONS ==========

    function populateActiveYearFilter() {
      // Year filter removed - using search bar instead
    }

    function applyActiveFilters() {
      const search = document.getElementById('active-search').value.toLowerCase();

      activeFilteredData = activeData.filter(row => {
        if (search) {
          // Include date/year in searchable fields
          const searchFields = [
            row.company,
            row.ocDate,
            ...row.sponsors,
            ...row.others
          ].join(' ').toLowerCase();
          if (!searchFields.includes(search)) return false;
        }

        return true;
      });

      sortActiveData();
      activeCurrentPage = 1;

      document.getElementById('active-count-badge').textContent =
        activeFilteredData.length.toLocaleString() + ' deals';

      renderActiveTableWithColumns();
      renderActivePagination();
    }

    function sortActiveData() {
      activeFilteredData.sort((a, b) => {
        let aVal = a[activeSortColumn] || '';
        let bVal = b[activeSortColumn] || '';

        if (activeSortColumn === 'ocDate') {
          const parseDate = (d) => {
            const parts = d.split('/');
            if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]).getTime();
            return 0;
          };
          aVal = parseDate(aVal);
          bVal = parseDate(bVal);
        } else {
          aVal = String(aVal).toLowerCase();
          bVal = String(bVal).toLowerCase();
        }

        if (aVal < bVal) return activeSortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return activeSortDir === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function renderActiveTableWithColumns() {
      const visibleCols = activeColumns.filter(c => c.visible);
      const thead = document.querySelector('#active-table thead');

      thead.innerHTML = `<tr>${visibleCols.map((col, idx) => {
        const sortClass = activeSortColumn === col.id ? (activeSortDir === 'asc' ? 'sorted-asc' : 'sorted-desc') : '';
        const sortAttr = col.sortable ? `data-sort="${col.id}"` : '';
        return `<th ${sortAttr} data-col-id="${col.id}" data-col-idx="${idx}" draggable="true" style="width: ${col.width}px;" class="${sortClass}">${col.label}<span class="resize-handle" data-col-idx="${idx}"></span></th>`;
      }).join('')}</tr>`;

      initActiveSortHandlers();
      initColumnResize('#active-table', activeColumns);
      initColumnDrag('#active-table', activeColumns, () => { renderActiveTableWithColumns(); renderActiveTable(); });
      renderActiveTable();
    }

    function initActiveSortHandlers() {
      document.querySelectorAll('#active-table th[data-sort]').forEach(th => {
        th.addEventListener('click', (e) => {
          if (e.target.classList.contains('resize-handle')) return;

          const col = th.dataset.sort;
          if (activeSortColumn === col) {
            activeSortDir = activeSortDir === 'asc' ? 'desc' : 'asc';
          } else {
            activeSortColumn = col;
            activeSortDir = 'asc';
          }
          document.querySelectorAll('#active-table th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
          th.classList.add(activeSortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
          sortActiveData();
          renderActiveTable();
        });
      });
    }

    function renderActiveTable() {
      const visibleCols = activeColumns.filter(c => c.visible);
      const start = (activeCurrentPage - 1) * pageSize;
      const pageData = activeFilteredData.slice(start, start + pageSize);
      const tbody = document.getElementById('active-table-body');

      if (pageData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${visibleCols.length}" class="empty-state">No active deals found</td></tr>`;
        return;
      }

      tbody.innerHTML = pageData.map(row => `
        <tr>
          ${visibleCols.map(col => renderActiveCell(row, col)).join('')}
        </tr>
      `).join('');
    }

    function renderActiveCell(row, col) {
      switch (col.id) {
        case 'company':
          // Note: HKEX URLs for OC announcements are currently broken, so no link
          const companyHtml = escapeHtml((row.company || '').replace(/Co\.,\s*Ltd\.?/gi, 'Co. Ltd.'));
          return `<td class="company-name">${companyHtml}</td>`;
        case 'ocDate':
          return `<td class="date-cell">${formatDate(row.ocDate)}</td>`;
        case 'sponsors':
          return `<td class="banks-cell">${row.sponsors.map(b => `<span class="bank-tag sponsor">${escapeHtml(b)}</span>`).join(' ') || '-'}</td>`;
        case 'others':
          return `<td class="banks-cell">${row.others.map(b => `<span class="bank-tag">${escapeHtml(b)}</span>`).join(' ') || '-'}</td>`;
        default:
          return `<td>-</td>`;
      }
    }

    function renderActivePagination() {
      const totalPages = Math.ceil(activeFilteredData.length / pageSize);
      const container = document.getElementById('active-pagination');

      if (totalPages <= 1) { container.innerHTML = ''; return; }

      container.innerHTML = `
        <button class="page-btn" onclick="goToActivePage(1)" ${activeCurrentPage === 1 ? 'disabled' : ''}>First</button>
        <button class="page-btn" onclick="goToActivePage(${activeCurrentPage - 1})" ${activeCurrentPage === 1 ? 'disabled' : ''}>Prev</button>
        <span class="page-info">Page ${activeCurrentPage} of ${totalPages}</span>
        <button class="page-btn" onclick="goToActivePage(${activeCurrentPage + 1})" ${activeCurrentPage === totalPages ? 'disabled' : ''}>Next</button>
        <button class="page-btn" onclick="goToActivePage(${totalPages})" ${activeCurrentPage === totalPages ? 'disabled' : ''}>Last</button>
      `;
    }

    function goToActivePage(page) {
      activeCurrentPage = page;
      renderActiveTable();
      renderActivePagination();
      window.scrollTo(0, 0);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Column resize functionality
    function initColumnResize(tableSelector, columnsArr) {
      const table = document.querySelector(tableSelector);
      const handles = table.querySelectorAll('.resize-handle');

      handles.forEach(handle => {
        handle.addEventListener('mousedown', (e) => {
          e.preventDefault();
          e.stopPropagation();

          const colIdx = parseInt(handle.dataset.colIdx);
          const th = handle.parentElement;
          const startX = e.pageX;
          const startWidth = th.offsetWidth;

          handle.classList.add('resizing');
          document.body.style.cursor = 'col-resize';
          document.body.style.userSelect = 'none';

          function onMouseMove(e) {
            const diff = e.pageX - startX;
            const newWidth = Math.max(50, startWidth + diff);
            th.style.width = newWidth + 'px';
            columnsArr[colIdx].width = newWidth;
          }

          function onMouseUp() {
            handle.classList.remove('resizing');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
          }

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
    }

    // Column drag-to-reorder functionality
    function initColumnDrag(tableSelector, columnsArr, rerenderFn) {
      const table = document.querySelector(tableSelector);
      const ths = table.querySelectorAll('th[draggable="true"]');
      let draggedIdx = null;

      ths.forEach(th => {
        th.addEventListener('dragstart', (e) => {
          // Don't drag if clicking resize handle
          if (e.target.classList.contains('resize-handle')) {
            e.preventDefault();
            return;
          }
          draggedIdx = parseInt(th.dataset.colIdx);
          th.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        th.addEventListener('dragend', () => {
          th.classList.remove('dragging');
          table.querySelectorAll('th').forEach(h => h.classList.remove('drag-over'));
          draggedIdx = null;
        });

        th.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });

        th.addEventListener('dragenter', (e) => {
          e.preventDefault();
          if (draggedIdx !== null && parseInt(th.dataset.colIdx) !== draggedIdx) {
            th.classList.add('drag-over');
          }
        });

        th.addEventListener('dragleave', () => {
          th.classList.remove('drag-over');
        });

        th.addEventListener('drop', (e) => {
          e.preventDefault();
          th.classList.remove('drag-over');
          const dropIdx = parseInt(th.dataset.colIdx);

          if (draggedIdx !== null && draggedIdx !== dropIdx) {
            // Reorder columns array
            const [removed] = columnsArr.splice(draggedIdx, 1);
            columnsArr.splice(dropIdx, 0, removed);
            rerenderFn();
          }
        });
      });
    }

    // Open prospectus PDF
    async function openProspectus(ticker) {
      try {
        const res = await fetch(`/api/deal-pdf-url/${ticker}`);
        const data = await res.json();
        if (data.url) {
          window.open(data.url, '_blank');
        } else {
          alert('No prospectus PDF available for this deal');
        }
      } catch (err) {
        console.error('Failed to fetch PDF URL:', err);
        alert('Failed to load prospectus');
      }
    }

    // Filter handlers
    document.getElementById('search').addEventListener('input', debounce(applyFilters, 300));
    document.getElementById('active-search').addEventListener('input', debounce(applyActiveFilters, 300));

    function debounce(fn, delay) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
      };
    }

    // Export to Excel
    function exportExcel() {
      const BOM = '\uFEFF';
      const visibleCols = columns.filter(c => c.visible);
      const headers = visibleCols.map(c => c.label);

      const csv = BOM + headers.join(',') + '\n' +
        filteredData.map(row => {
          return visibleCols.map(col => {
            let value;
            switch(col.id) {
              case 'ticker': value = row.ticker; break;
              case 'company': value = formatCompanyName(row.company, row.companyCn); break;
              case 'date': value = row.date; break;
              case 'sizeHKDm': value = row.sizeHKDm || ''; break;
              case 'sponsors': value = row.sponsors.join('; '); break;
              case 'others': value = row.others.join('; '); break;
              default: value = '';
            }
            return `"${String(value || '').replace(/"/g, '""')}"`;
          }).join(',');
        }).join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ipo-deals-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Initialize
    loadActiveData();
    loadData();
  </script>
</body>
</html>
