<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPO Tracker - DD Owl</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
      background: #0a0a0a;
      color: #e0e0e0;
      min-height: 100vh;
    }
    /* Navigation */
    .top-nav {
      background: #111;
      border-bottom: 1px solid #222;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 32px;
    }
    .nav-links {
      display: flex;
      gap: 8px;
    }
    .nav-link {
      padding: 8px 16px;
      color: #888;
      text-decoration: none;
      font-size: 13px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .nav-link:hover {
      color: #fff;
      background: #1a1a1a;
    }
    .nav-link.active {
      color: #fff;
      background: #222;
    }
    .header {
      background: #111;
      border-bottom: 1px solid #222;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 24px;
    }
    .logo {
      font-weight: 700;
      font-size: 1.25rem;
      color: #fff;
    }
    .tabs {
      display: flex;
      gap: 4px;
    }
    .tab {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid #333;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-family: inherit;
      color: #888;
      transition: all 0.2s;
    }
    .tab:hover {
      background: #1a1a1a;
      color: #fff;
    }
    .tab.active {
      background: #fff;
      color: #000;
      border-color: #fff;
    }
    .container {
      padding: 24px;
      max-width: 1800px;
      margin: 0 auto;
    }
    .toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    .search-box {
      padding: 10px 14px;
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 0.9rem;
      font-family: inherit;
      width: 280px;
      background: #111;
      color: #fff;
      outline: none;
    }
    .search-box:focus {
      border-color: #4a9eff;
    }
    .search-box::placeholder {
      color: #555;
    }
    .filter-select {
      padding: 10px 14px;
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 0.9rem;
      font-family: inherit;
      background: #111;
      color: #e0e0e0;
      cursor: pointer;
    }
    .filter-select:focus {
      border-color: #4a9eff;
      outline: none;
    }
    .count-badge {
      background: #1a1a1a;
      border: 1px solid #333;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      color: #888;
      margin-left: auto;
    }
    .table-container {
      background: #111;
      border-radius: 8px;
      border: 1px solid #222;
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    th {
      background: #1a1a1a;
      padding: 12px 14px;
      text-align: left;
      font-weight: 600;
      color: #888;
      border-bottom: 1px solid #222;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 1px;
    }
    th:hover { background: #222; color: #fff; }
    th.sorted-asc::after { content: ' ▲'; color: #4a9eff; }
    th.sorted-desc::after { content: ' ▼'; color: #4a9eff; }
    td {
      padding: 12px 14px;
      border-bottom: 1px solid #1a1a1a;
      vertical-align: middle;
      color: #ccc;
    }
    tr:hover { background: #1a1a1a; }
    .company-name {
      font-weight: 500;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 280px;
    }
    .ticker {
      color: #4a9eff;
      font-weight: 600;
    }
    .status-active {
      background: #1a3a1a;
      color: #2ed573;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-listed {
      background: #1a2a3a;
      color: #4a9eff;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .bank-tag {
      display: inline-block;
      background: #1a1a1a;
      border: 1px solid #333;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      margin: 2px 4px 2px 0;
      color: #aaa;
    }
    .bank-tag.sponsor {
      background: #2a2a1a;
      border-color: #ffa502;
      color: #ffa502;
    }
    .role-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .role-sponsor {
      background: #2a1a1a;
      color: #ffa502;
      border: 1px solid #ffa502;
    }
    .role-other {
      background: #1a1a2a;
      color: #888;
      border: 1px solid #333;
    }
    .date-cell {
      color: #666;
      white-space: nowrap;
      font-size: 0.8rem;
    }
    .banks-cell {
      line-height: 1.8;
    }
    .export-btn {
      background: #1a1a1a;
      color: #888;
      border: 1px solid #333;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-family: inherit;
      transition: all 0.2s;
    }
    .export-btn:hover {
      background: #222;
      color: #fff;
      border-color: #444;
    }
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #555;
    }
    .empty-state h3 {
      font-size: 1.1rem;
      color: #888;
      margin-bottom: 8px;
    }
    .section { display: none; }
    .section.active { display: block; }

    /* Pipeline placeholder */
    .pipeline-placeholder {
      background: #111;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 60px 40px;
      text-align: center;
    }
    .pipeline-placeholder h2 {
      color: #fff;
      margin-bottom: 12px;
      font-size: 1.25rem;
    }
    .pipeline-placeholder p {
      color: #666;
      font-size: 0.9rem;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 20px;
    }
    .page-btn {
      padding: 8px 14px;
      background: #1a1a1a;
      border: 1px solid #333;
      color: #888;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.85rem;
    }
    .page-btn:hover {
      background: #222;
      color: #fff;
    }
    .page-btn.active {
      background: #4a9eff;
      color: #000;
      border-color: #4a9eff;
    }
    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .page-info {
      color: #666;
      font-size: 0.85rem;
      padding: 8px 14px;
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <div class="nav-links">
      <a href="/" class="nav-link">Screening</a>
      <a href="/ipo" class="nav-link active">IPO Tracker</a>
    </div>
  </nav>
  <div class="header">
    <div class="logo">IPO Tracker</div>
    <div class="tabs">
      <button class="tab active" data-section="pipeline">Pipeline</button>
      <button class="tab" data-section="historical">Historical</button>
    </div>
  </div>

  <div class="container">
    <!-- PIPELINE SECTION -->
    <div class="section active" id="pipeline-section">
      <div class="pipeline-placeholder">
        <h2>Deal Pipeline</h2>
        <p>Active HKEX listing applications will appear here.</p>
        <p style="margin-top: 16px; color: #444;">Coming soon: Real-time tracking of IPO applications</p>
      </div>
    </div>

    <!-- HISTORICAL SECTION -->
    <div class="section" id="historical-section">
      <div class="toolbar">
        <input type="text" class="search-box" id="search" placeholder="Search company or bank...">
        <select class="filter-select" id="year-filter">
          <option value="">All Years</option>
        </select>
        <button class="export-btn" onclick="exportExcel()">Download Excel</button>
        <span class="count-badge" id="count-badge">Loading...</span>
      </div>
      <div class="table-container">
        <table id="data-table">
          <thead>
            <tr>
              <th data-sort="ticker" style="width: 70px;">Ticker</th>
              <th data-sort="company" style="width: 220px;">Company</th>
              <th data-sort="date" style="width: 100px;">Prospectus</th>
              <th>Sponsors</th>
              <th>Others</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <script>
    let rawData = [];
    let allData = [];
    let filteredData = [];
    let sortColumn = 'date';
    let sortDir = 'desc';
    let currentPage = 1;
    const pageSize = 50;

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.section + '-section').classList.add('active');
      });
    });

    // Load CSV data
    async function loadData() {
      try {
        const response = await fetch('/baseline-export.csv');
        const text = await response.text();
        const lines = text.split('\n');
        const headers = parseCSVLine(lines[0]);

        rawData = [];
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          const values = parseCSVLine(lines[i]);
          const row = {};
          headers.forEach((h, idx) => {
            row[h] = values[idx] || '';
          });
          rawData.push(row);
        }

        // Group by deal
        groupByDeal();
        populateYearFilter();
        applyFilters();
      } catch (err) {
        console.error('Failed to load data:', err);
        document.getElementById('table-body').innerHTML =
          '<tr><td colspan="5" class="empty-state">Failed to load data</td></tr>';
      }
    }

    function groupByDeal() {
      const deals = new Map();

      for (const row of rawData) {
        const key = row.ticker;
        let deal = deals.get(key);

        if (!deal) {
          deal = {
            ticker: row.ticker,
            company: cleanCompanyName(row.company),
            date: row.date,
            sponsors: new Set(),
            others: new Set()
          };
          deals.set(key, deal);
        }

        const bank = cleanBankName(row.bank_normalized);
        if (!bank || isGarbageBank(bank)) continue;

        if (row.is_sponsor === 'Y') {
          deal.sponsors.add(bank);
          deal.others.delete(bank);
        } else if (!deal.sponsors.has(bank)) {
          deal.others.add(bank);
        }
      }

      allData = Array.from(deals.values()).map(d => ({
        ticker: d.ticker,
        company: d.company,
        date: d.date,
        sponsors: Array.from(d.sponsors).sort(),
        others: Array.from(d.others).sort()
      }));
    }

    function cleanCompanyName(name) {
      if (!name) return '';
      // Remove -W, -B, -S suffixes
      return name.replace(/\s+-\s*[WBS]$/i, '').trim();
    }

    function cleanBankName(name) {
      if (!name) return '';
      return name
        .replace(/\s+/g, ' ')
        .replace(/\s*Company$/i, '')
        .replace(/\s*Co\.?$/i, '')
        .replace(/\s*Limited$/i, '')
        .replace(/\s*Ltd\.?$/i, '')
        .trim();
    }

    function isGarbageBank(name) {
      if (!name || name.length < 3) return true;
      // Filter out garbage/prose
      const garbage = [
        /^futures$/i,
        /^securities$/i,
        /^capital$/i,
        /is a$/i,
        /Limited:$/i,
        /Financial adviser/i,
        /joint stock/i,
        /into a/i,
      ];
      return garbage.some(p => p.test(name));
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    }

    function populateYearFilter() {
      const years = new Set();
      allData.forEach(row => {
        if (row.date) {
          const parts = row.date.split('/');
          if (parts.length === 3) years.add(parts[2]);
        }
      });

      const select = document.getElementById('year-filter');
      const sortedYears = Array.from(years).sort().reverse();
      select.innerHTML = '<option value="">All Years</option>' +
        sortedYears.map(y => `<option value="${y}">${y}</option>`).join('');
    }

    function applyFilters() {
      const search = document.getElementById('search').value.toLowerCase();
      const yearFilter = document.getElementById('year-filter').value;

      filteredData = allData.filter(row => {
        if (search) {
          const searchFields = [
            row.company,
            row.ticker,
            ...row.sponsors,
            ...row.others
          ].join(' ').toLowerCase();
          if (!searchFields.includes(search)) return false;
        }

        if (yearFilter) {
          const parts = (row.date || '').split('/');
          if (parts.length !== 3 || parts[2] !== yearFilter) return false;
        }

        return true;
      });

      sortData();
      currentPage = 1;

      document.getElementById('count-badge').textContent =
        filteredData.length.toLocaleString() + ' deals';

      renderTable();
      renderPagination();
    }

    function sortData() {
      filteredData.sort((a, b) => {
        let aVal = a[sortColumn] || '';
        let bVal = b[sortColumn] || '';

        if (sortColumn === 'date') {
          const parseDate = (d) => {
            const parts = d.split('/');
            if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]).getTime();
            return 0;
          };
          aVal = parseDate(aVal);
          bVal = parseDate(bVal);
        } else if (sortColumn === 'ticker') {
          aVal = parseInt(aVal) || 0;
          bVal = parseInt(bVal) || 0;
        } else {
          aVal = String(aVal).toLowerCase();
          bVal = String(bVal).toLowerCase();
        }

        if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
        return 0;
      });
    }

    function renderTable() {
      const start = (currentPage - 1) * pageSize;
      const pageData = filteredData.slice(start, start + pageSize);
      const tbody = document.getElementById('table-body');

      if (pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No results found</td></tr>';
        return;
      }

      tbody.innerHTML = pageData.map(row => `
        <tr>
          <td class="ticker">${row.ticker}</td>
          <td class="company-name">${escapeHtml(row.company)}</td>
          <td class="date-cell">${formatDate(row.date)}</td>
          <td class="banks-cell">${row.sponsors.map(b => `<span class="bank-tag sponsor">${escapeHtml(b)}</span>`).join('') || '-'}</td>
          <td class="banks-cell">${row.others.map(b => `<span class="bank-tag">${escapeHtml(b)}</span>`).join('') || '-'}</td>
        </tr>
      `).join('');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const parts = dateStr.split('/');
      if (parts.length !== 3) return dateStr;
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return `${months[parseInt(parts[1]) - 1]} ${parts[2]}`;
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredData.length / pageSize);
      const container = document.getElementById('pagination');

      if (totalPages <= 1) { container.innerHTML = ''; return; }

      container.innerHTML = `
        <button class="page-btn" onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>First</button>
        <button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Prev</button>
        <span class="page-info">Page ${currentPage} of ${totalPages}</span>
        <button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
        <button class="page-btn" onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last</button>
      `;
    }

    function goToPage(page) {
      currentPage = page;
      renderTable();
      renderPagination();
      window.scrollTo(0, 0);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Sorting
    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.sort;
        if (sortColumn === col) {
          sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = col;
          sortDir = 'asc';
        }
        document.querySelectorAll('th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
        th.classList.add(sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
        sortData();
        renderTable();
      });
    });

    // Filter handlers
    document.getElementById('search').addEventListener('input', debounce(applyFilters, 300));
    document.getElementById('year-filter').addEventListener('change', applyFilters);

    function debounce(fn, delay) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
      };
    }

    // Export to Excel
    function exportExcel() {
      const BOM = '\uFEFF';
      const headers = ['Ticker', 'Company', 'Date', 'Sponsors', 'Others'];

      const csv = BOM + headers.join(',') + '\n' +
        filteredData.map(row =>
          [row.ticker, row.company, row.date, row.sponsors.join('; '), row.others.join('; ')]
            .map(v => `"${String(v || '').replace(/"/g, '""')}"`)
            .join(',')
        ).join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ipo-deals-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    loadData();
  </script>
</body>
</html>
